# 📱 WebRTC实时投屏项目 - 完整操作说明

## 🎯 项目概述

这是一个基于WebRTC技术的实时屏幕投屏系统，支持Android设备向Web浏览器实时投屏。

### 🌟 主要特性

- ✅ **实时投屏**：Android屏幕内容实时传输到Web端
- ✅ **双投屏模式**：支持整个屏幕投屏 & 仅App内容投屏
- ✅ **一键启动**：权限授权后自动继续，无需重复操作
- ✅ **服务器配置**：支持自定义服务器地址，方便部署和测试
- ✅ **性能优化**：低延迟、低资源消耗、稳定运行

## 🏗️ 系统架构

```
Android App (投屏端)  ←→  Node.js服务器 (信令)  ←→  Web客户端 (观看端)
     📱                     🖥️                     🌐
   - 采集画面              - Socket.IO            - 接收视频流  
   - WebRTC发送            - 信令转发              - 实时显示
   - 状态管理              - 房间管理              - 连接控制
```

## 📦 项目结构

```
webrtc/
├── 📱 app/                          # Android应用
│   ├── src/main/java/com/example/webrtc/
│   │   ├── MainActivity.kt          # 主界面（投屏控制）
│   │   ├── config/                  # 配置文件
│   │   ├── manager/                 # 核心管理模块
│   │   │   ├── WebRTCManager.kt     # WebRTC连接管理
│   │   │   ├── ScreenCaptureManager.kt # 屏幕录制管理
│   │   │   ├── ViewCapturer.kt      # App内容录制
│   │   │   └── SocketIOSignalingManager.kt # 信令管理
│   │   └── model/                   # 数据模型
│   └── build.gradle.kts             # Android构建配置
├── 🖥️ signaling-server/             # Node.js信令服务器
│   ├── server.js                    # 服务器主文件
│   └── package.json                 # 服务器依赖
├── 🌐 web-client/                   # Web客户端
│   ├── index.html                   # 主页面
│   ├── js/                          # JavaScript文件
│   └── css/                         # 样式文件
├── 🛠️ *.bat                         # Windows启动脚本
└── 📚 README.md                     # 项目说明
```

## 🚀 快速开始

### 步骤1：启动服务器

**手动启动**（推荐）：
```bash
cd signaling-server
npm install
node server.js
```

**详细步骤**：
1. 打开命令行（cmd或PowerShell）
2. 进入项目目录的signaling-server子目录
3. 运行`npm install`安装依赖（首次运行）
4. 运行`node server.js`启动服务器

服务器默认运行在：`http://localhost:3000`

### 步骤2：配置服务器地址

1. **获取服务器IP地址**：
   - Windows: 运行 `ipconfig` 查看内网IP
   - 例如：`192.168.1.100`

2. **在Android App中配置**：
   - 打开App
   - 点击"服务器配置"右侧的编辑按钮 ✏️
   - 输入服务器地址，例如：`192.168.1.100:3000`
   - 点击刷新按钮重新连接

### 步骤3：开始投屏

**Android端操作**：
1. 确认服务器连接状态为"已连接" ✅
2. 选择投屏模式：
   - **仅App内容**：只投屏App内的指定区域（推荐）
   - **整个屏幕**：投屏完整手机屏幕
3. 点击"开始投屏"按钮
4. 如选择整个屏幕，需要授权屏幕录制权限

**Web端观看**：
1. 浏览器打开：`http://服务器IP:3000`
2. 输入与Android相同的房间ID
3. 点击"连接"按钮
4. 等待视频流出现

## 📱 Android App 详细功能

### 🎛️ 界面功能说明

1. **标题区域**：显示App名称和功能介绍
2. **连接状态区域**：
   - 信令服务器：连接状态（未连接/连接中/已连接/错误）
   - WebRTC连接：P2P连接状态
   - 屏幕共享：投屏状态（空闲/准备中/投屏中/已停止）

3. **服务器配置区域**：
   - 显示当前服务器地址
   - 支持编辑和重新连接
   - 显示Web客户端访问地址

4. **投屏模式选择**：
   - **仅App内容**：录制App内指定区域，无需系统权限
   - **整个屏幕**：录制完整屏幕，需要屏幕录制权限

5. **投屏内容预览**（仅App内容模式）：
   - 实时显示投屏区域内容
   - 每秒更新时间和状态信息
   - 预览投屏效果

6. **控制区域**：
   - 开始/停止投屏按钮
   - 连接/断开服务器按钮

7. **房间信息区域**：
   - 房间ID设置（默认：DEMO_ROOM）
   - 用户ID显示（自动生成）
   - 远程用户连接状态

### 🔧 投屏模式对比

| 特性 | 仅App内容 | 整个屏幕 |
|------|-----------|----------|
| **权限需求** | 无需特殊权限 | 需要屏幕录制权限 |
| **启动速度** | 立即开始 | 需要权限授权 |
| **隐私保护** | ✅ 高（只显示App内容） | ⚠️ 低（显示完整屏幕） |
| **画质** | 灰度效果，流畅优先 | 全彩，质量较高 |
| **性能消耗** | 低（5fps, 480x320） | 中等（系统默认） |
| **适用场景** | 演示、教学、隐私场景 | 完整屏幕展示 |

## 🌐 Web客户端功能

### 📺 观看端操作

1. **访问地址**：`http://服务器IP:3000`
2. **连接控制**：
   - 输入房间ID（与Android端一致）
   - 点击"连接投屏设备"
   - 显示连接状态和日志

3. **视频显示**：
   - 自动适应视频尺寸
   - 实时显示投屏内容
   - 支持全屏查看

4. **连接日志**：
   - 实时显示连接状态
   - WebRTC连接进度
   - 错误信息提示

## 🛠️ 部署和配置

### 服务器部署

**前提条件**：
- 安装Node.js (https://nodejs.org/)
- 确保npm可用

**本地测试**：
```bash
# 1. 打开命令行，进入项目目录
cd 你的项目路径/webrtc

# 2. 进入服务器目录
cd signaling-server

# 3. 安装依赖（首次运行）
npm install

# 4. 启动服务器
node server.js
```

**验证启动成功**：
- 命令行显示："服务器启动成功！"
- 浏览器访问 http://localhost:3000 能打开页面

**生产部署**：
```bash
# 使用PM2进程管理
npm install -g pm2
pm2 start server.js --name webrtc-server
pm2 startup
pm2 save
```

### 网络配置

1. **内网使用**：
   - 确保Android设备和Web客户端在同一网络
   - 使用内网IP地址（如：192.168.1.100）

2. **公网部署**：
   - 服务器需要公网IP或域名
   - 配置防火墙开放3000端口
   - 考虑使用HTTPS（需要修改代码）

3. **端口配置**：
   - 默认端口：3000
   - 修改：编辑 `signaling-server/server.js` 中的端口设置

## 🔧 故障排除

### 常见问题

1. **Android无法连接服务器**：
   - 检查服务器是否启动（`http://IP:3000`能否访问）
   - 确认IP地址配置正确
   - 检查防火墙设置
   - 确认设备在同一网络

2. **Web端看不到视频**：
   - 检查房间ID是否一致
   - 确认Android端已开始投屏
   - 查看浏览器控制台错误信息
   - 尝试刷新页面重新连接

3. **投屏卡顿或延迟**：
   - 检查网络质量
   - 尝试"仅App内容"模式（性能更好）
   - 重启App和Web客户端

4. **权限问题**：
   - Android 9+需要允许HTTP明文传输
   - 屏幕录制需要用户授权
   - 检查通知权限（Android 13+）

### 调试方法

**Android端日志**：
```bash
adb logcat | findstr "WebRTC\|ViewCapturer\|Socket"
```

**Web端调试**：
- 打开浏览器开发者工具（F12）
- 查看Console面板的错误信息
- 检查Network面板的连接状态

## 🔄 版本历史

### v1.0.0 - 完整版本
- ✅ 实现Android到Web的实时投屏
- ✅ 支持两种投屏模式（App内容/整个屏幕）
- ✅ 添加服务器地址配置功能
- ✅ 优化性能，解决卡顿问题
- ✅ 完善UI状态管理

### 技术栈
- **Android**: Kotlin + Jetpack Compose + WebRTC
- **服务器**: Node.js + Socket.IO + Express
- **Web端**: HTML5 + JavaScript + WebRTC API
- **通信协议**: WebRTC + Socket.IO

## 📞 技术支持

### 联系方式
- 项目仓库：[GitHub链接]
- 技术文档：[详细API文档]
- 问题反馈：[Issues页面]

### 开发指南
如需修改或扩展功能，请参考：
- Android端：`MainActivity.kt` - 主要业务逻辑
- ViewCapturer：`ViewCapturer.kt` - App内容录制
- 服务器端：`server.js` - 信令逻辑
- Web端：`js/app.js` - 客户端逻辑

---

## 🎉 开始使用

1. **下载项目**：获取完整项目文件
2. **启动服务器**：运行 `start-server.bat`
3. **安装APK**：安装Android应用到设备
4. **配置地址**：在App中设置服务器IP
5. **开始投屏**：选择模式，点击开始！

祝使用愉快！🚀 